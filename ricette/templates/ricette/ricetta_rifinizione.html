{% extends 'core/base.html' %} 
{% load static %}
{% load crispy_forms_tags %} 
{% load widget_tweaks %}
{% block head_title %}{{ block.super }} - Ricetta Rifinizione{% endblock head_title %} 

{% block sidenav %}
{% include "core/partials/_sidenav_chem_man.html" %}
{% endblock %}

{% block content %}
{% include 'core/modals/delConfirm.html' %}

<nav aria-label="breadcrumb" class="mt-3"> 
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'home' %}">Home</a></li>      
        <li class="breadcrumb-item"><a href="{% url 'ricette:home_ricette_rifinizione' %}">Home Ricette</a></li>     
        
        {% if form.instance.id  %}
            <li class="breadcrumb-item active" aria-current="page">Modifica {{ ricettarifinizione }}</li>
        {% else %}
            <li class="breadcrumb-item active" aria-current="page">Aggiungi Ricetta Rifinizione</li>
        {% endif %}     
    </ol>

</nav>

<div class="container">
    <br>
    
    <div class="container">
      {% if form.instance.id  %}
          <h3>Modifica {{ ricettarifinizione }}</h3>
      {% else %}
          <h3> Aggiungi Ricetta Rifinizione</h3>
      {% endif %}
    <hr>
    <br>
    {% include "core/partials/_messages.html" %}
    
    <!-- Form nuovo registro -->
    
    <div class="form-group mt-3">
        <form class="mt-3" method="POST" novalidate enctype="multipart/form-data">
            {% csrf_token %}

            {% if form.errors %}
    {% for field in form %}
        {% for error in field.errors %}
            <p> {{ error }} </p>
        {% endfor %}
    {% endfor %}
{% endif %}


            <input type="hidden" id="previous_page" name="previous_page"
            value="/previous/page/url">
            <input type="submit" name="salva_esci" class="btn btn-success mb-2 me-1" value="Salva ed Esci">
            <input type="submit" name="salva_continua" class="btn btn-success mb-2 me-1" value="Salva e continua">
            <button type="button" class="btn btn-danger mb-2 me-1" onclick="goBack()"><i class="bi bi-arrow-counterclockwise"></i> Annulla</button>
            
            

            
                    <div class="row mb-4">
                      
                      <div class="col-md-12 border rounded shadow-sm">
                        <div class="row mt-3">
                            <div class = "col-md-2">
                              {{ form.numero_ricetta|as_crispy_field }}
                            </div>
                            <div class = "col-md-2">
                              {{ form.data_ricetta|as_crispy_field }}
                            </div>
                            <div class="col-md-2">
                              {{ form.numero_revisione|as_crispy_field }}
                            </div>
                            <div class="col-md-2">
                              {{ form.data_revisione|as_crispy_field }}
                            </div>
                            <div class="col-md-2">
                              {{ form.ricetta_per_pelli|as_crispy_field }}
                            </div>
                            
                        </div>
                        <div class="row">  
                          <div class="col-md-5">
                            {{ form.fk_articolo|as_crispy_field }} 
                          </div> 
                          
                                                      
                        </div>
                        <div class="row">
                          <div class="col-6">
                            {{ form.note|as_crispy_field }}
                          </div>
                            

                          <div class="col-5 text-end">
                          <h3>Costo: {{ ricettarifinizione.calcola_totale_prezzi }}</h3>
                          </div>

                          <div class="col-md-1">
                              {{ form.created_by|as_crispy_field }}
                          </div>
                        </div>
                        
                        <hr>
                        

                        

                    </div>
                      </div>

        <!-- fine form -->
        </form>

        

    </div>



    <div class="row">
      

      {% if form.instance.id  %}
          
      {% include "ricette/partials/_dettaglio_ricetta_rifinizione_table.html" %}
  
      {% else %}
          <h3> Non sono presenti righe di dettaglio.</h3>
      {% endif %}


      

</div>


    

</div> <!--Fine container-->
{% endblock content %}

{% block extra_scripts %}
<script>
var searchURL = "{% url 'ricette:update_numero_riga' %}";
var pk_ricetta_rifinizione = {{ ricettarifinizione.pk }};
console.log("pk_ricetta: " + pk_ricetta_rifinizione)

$(document).ready(function() {
  $(".move-up").click(function() {
    moveRow("up");
  });

  $(".move-down").click(function() {
    moveRow("down");
  });

  function moveRow(direction) {
    const selectedInstance = $(".select-instance:checked");
    if (selectedInstance.length === 0) {
      alert("Seleziona un'istanza prima di spostarla.");
      return;
    }

    const currentRow = selectedInstance.closest("tr");
    const targetRow = direction === "up" ? currentRow.prev() : currentRow.next();
    console.log("currentRow: " + currentRow);
    console.log("targetRow: " + targetRow);

    if (targetRow.length === 0) {
      // Non puoi spostarti oltre i limiti della tabella
      return;
    }

    const currentNumber = currentRow.find("a[id^='numero_riga_']").text();
    const targetNumber = targetRow.find("a[id^='numero_riga_']").text();
    console.log("currentNumber: " + currentNumber);
    console.log("targetNumber: " + targetNumber);

    if (isNaN(currentNumber) || isNaN(targetNumber)) {
      alert("Il numero di riga non è valido.");
      return;
    }

    currentRow.find("a[id^='numero_riga_']").text(targetNumber);
    targetRow.find("a[id^='numero_riga_']").text(currentNumber);

    // Aggiorna i valori nel form e invia eventuali modifiche al server
    const currentInstanceId = selectedInstance.data("id");
    const targetInstanceId = targetRow.find(".select-instance").data("id");
    console.log("Instance id: " + currentInstanceId);
    console.log("targetInstanceId: " + targetInstanceId);

    // Esegui una richiesta AJAX per aggiornare il numero di riga nel server
    $.ajax({
      url: searchURL, // Sostituisci con l'URL effettivo della tua vista
      headers: {
        "Accept": "application/json", // Imposta l'header "Accept" a "application/json"
      },
      method: 'POST',
      data: {
        instance_id: currentInstanceId,
        new_numero_riga: currentNumber,
        target_instance_id: targetInstanceId,
        target_new_numero_riga: targetNumber,
        csrfmiddlewaretoken: '{{ csrf_token }}' // Assicurati di includere il token CSRF se necessario
      },
      success: function(response) {
        if (response.success === true) {
          // L'operazione è riuscita
          console.log("Successo!");
        }

        if (response.success) {
          console.log("response: " + response);
          // Aggiornamento riuscito, puoi eseguire ulteriori azioni qui se necessario
          currentRow.find("a[id^='numero_riga_']").text(targetNumber);
          console.log("currentRow: " + currentRow.find("a[id^='numero_riga_']").text(currentNumber));
          // Aggiorna il numero di riga nella riga di destinazione
          targetRow.find("a[id^='numero_riga_']").text(currentNumber);
          console.log("targetRow: " + targetRow.find("#id_numero_riga").text(targetNumber));

          // Deseleziona tutte le caselle di controllo
          $(".select-instance:checked").prop("checked", false);

          // Ora invia una seconda richiesta AJAX per aggiornare il numero di riga della riga di destinazione
          $.ajax({
            url: searchURL,
            headers: {
              "Accept": "application/json",
            },
            method: 'POST',
            data: {
              instance_id: targetInstanceId,  // Usa l'ID della riga di destinazione -->
              //target_instance_id: targetInstanceId,
              new_numero_riga: targetNumber,   // Usa il nuovo numero di riga della riga di destinazione
              //target_new_numero_riga: targetNumber,
              csrfmiddlewaretoken: '{{ csrf_token }}'
            },
            success: function(response) {
              if (response.success) {
                console.log("Aggiornamento della riga di destinazione riuscito.");
                //refreshTable(pk_ricetta_rifinizione);
              } else {
                console.log("Errore nell'aggiornamento della riga di destinazione: " + response.error_message);
              }
            },
            error: function() {
              console.log("Errore durante la richiesta AJAX per l'aggiornamento della riga di destinazione.");
            }
          });
        } else {
          console.log("Fail!");
          console.log("Errore durante l'aggiornamento del numero di riga: " + response.error_message);
        }
      },
      error: function() {
        alert("Si è verificato un errore durante la richiesta AJAX.");
      }
    });

    // Dopo l'aggiornamento, puoi aggiornare la vista se necessario
  }
});


function refreshTable(pk_ricetta_rifinizione) {
  // Effettua una richiesta AJAX per ottenere i dati aggiornati
  $.ajax({
    url: "{% url 'ricette:get_updated_table_data' %}",
    method: 'GET',  // Utilizza il metodo HTTP GET
    dataType: 'json',
    data: {
      pk_ricetta_rifinizione: pk_ricetta_rifinizione
    },
    success: function(response) {
      if (response.success) {
        // Aggiorna la tabella con i nuovi dati
        var tableBody = $("#tabella_dettaglio");  // Sostituisci con l'ID corretto del corpo della tabella
        tableBody.html(response.table_html); // Assume che il server restituisca l'HTML della tabella aggiornata
      } else {
        console.log("Errore nell'ottenere i dati aggiornati.");
      }
    },
    error: function() {
      console.log("Errore durante la richiesta AJAX per i dati aggiornati.");
    }
  });
};

// Chiamare la funzione refreshTable() dopo aver completato con successo la seconda richiesta AJAX

var updateURL = "{% url 'ricette:get_updated_table_data' %}";
var pk_ricetta_rifinizione = {{ ricettarifinizione.pk }};
$(document).ready(function () {
  // Aggiorna la tabella quando la pagina è pronta
  updateTable();

  // Funzione per aggiornare la tabella
  function updateTable() {
      //var pk_ricetta_rifinizione = // Ottieni il valore appropriato

      $.ajax({
          url: updateURL,
          type: 'GET',
          data: {'pk_ricetta_rifinizione': pk_ricetta_rifinizione},
          success: function (data) {
              // Aggiorna il contenuto della tabella con i dati ricevuti dalla chiamata AJAX
              $('#tabella_dettaglio').html(data);
          },
          error: function (xhr, status, error) {
              console.error(error);
          }
      });
  }
});




</script>
{% endblock %}